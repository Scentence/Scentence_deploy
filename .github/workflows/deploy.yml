name: CD - Deploy to EC2

on:
  workflow_dispatch:  # ÏàòÎèô Ïã§Ìñâ Í∞ÄÎä•

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2
      
      - name: Get GitHub Actions IP
        id: ip
        uses: haythem/public-ip@v1.2
      
      - name: Add GitHub Actions IP to Security Group
        run: |
          aws ec2 authorize-security-group-ingress \
            --group-id ${{ secrets.AWS_SG_ID }} \
            --protocol tcp \
            --port 22 \
            --cidr ${{ steps.ip.outputs.ipv4 }}/32
        continue-on-error: true
      
      - name: Deploy notification
        run: |
          echo "üöÄ Starting deployment: ${{ github.sha }}"
          echo "Author: ${{ github.actor }}"
          echo "Commit message: ${{ github.event.head_commit.message }}"
      
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            echo "üì¶ Starting deployment..."
            echo "Current user: $(whoami)"
            echo "Current location: $(pwd)"
            echo "Home directory: $HOME"
            
            # Find project directory
            echo "üîç Searching for project directory..."
            if [ -d "$HOME/scentence" ]; then
              PROJECT_DIR="$HOME/scentence"
              echo "‚úÖ Found: $PROJECT_DIR"
            elif [ -d "$HOME/Scentence_aws" ]; then
              PROJECT_DIR="$HOME/Scentence_aws"
              echo "‚úÖ Found: $PROJECT_DIR"
            elif [ -d "$HOME/Scentence_aws_test" ]; then
              PROJECT_DIR="$HOME/Scentence_aws_test"
              echo "‚úÖ Found: $PROJECT_DIR"
            elif [ -d "/home/ubuntu/scentence" ]; then
              PROJECT_DIR="/home/ubuntu/scentence"
              echo "‚úÖ Found: $PROJECT_DIR"
            else
              echo "‚ùå Project directory not found!"
              echo "Home directory contents:"
              ls -la "$HOME/" || true
              echo "Root directory contents:"
              ls -la / || true
              exit 1
            fi
            
            echo "üìÅ Moving to project directory: $PROJECT_DIR"
            cd "$PROJECT_DIR" || { echo "‚ùå cd failed!"; exit 1; }
            echo "‚úÖ Moved successfully. Current location: $(pwd)"
            
            # Pull latest code
            echo "üîÑ Fetching latest code..."
            git fetch origin || { echo "‚ùå git fetch failed!"; exit 1; }
            git reset --hard origin/main || { echo "‚ùå git reset failed!"; exit 1; }
            echo "‚úÖ Code updated successfully"
            
            # Check .env file
            if [ ! -f .env ]; then
              echo "‚ùå .env file not found!"
              exit 1
            fi
            
            # Rebuild and deploy Docker images
            echo "üê≥ Restarting Docker containers..."
            docker compose -f docker-compose.production.yml down || echo "‚ö†Ô∏è No existing containers"
            docker compose -f docker-compose.production.yml build --no-cache || { echo "‚ùå Docker build failed!"; exit 1; }
            docker compose -f docker-compose.production.yml up -d || { echo "‚ùå Docker start failed!"; exit 1; }
            echo "‚úÖ Docker containers started successfully"
            
            # Check container status
            echo "‚úÖ Deployment complete! Container status:"
            docker ps
            
            # Wait for health check
            echo "üè• Waiting for health check..."
            sleep 30
            
            # Clean up old images
            echo "üßπ Cleaning up old Docker resources..."
            docker image prune -af --filter "until=24h"
      
      - name: Remove GitHub Actions IP from Security Group
        if: always()
        run: |
          aws ec2 revoke-security-group-ingress \
            --group-id ${{ secrets.AWS_SG_ID }} \
            --protocol tcp \
            --port 22 \
            --cidr ${{ steps.ip.outputs.ipv4 }}/32
        continue-on-error: true
      
      - name: Health check
        run: |
          echo "üè• Checking services health..."
          
          # Backend health check
          curl -f https://scentence.kro.kr/api/backend-openapi || exit 1
          echo "‚úÖ Backend is healthy"
          
          # Scentmap health check
          curl -f https://scentence.kro.kr/api/scentmap-health || exit 1
          echo "‚úÖ Scentmap is healthy"
          
          # Layering health check
          curl -f https://scentence.kro.kr/api/layering-health || exit 1
          echo "‚úÖ Layering is healthy"
          
          echo "üéâ All services are running!"
      
      - name: Deployment success notification
        if: success()
        run: |
          echo "‚úÖ Deployment successful!"
          echo "URL: https://scentence.kro.kr"
          echo "Commit: ${{ github.sha }}"
      
      - name: Deployment failure notification
        if: failure()
        run: |
          echo "‚ùå Deployment failed!"
          echo "Please check the logs."
