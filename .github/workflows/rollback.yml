name: Rollback - ì´ì „ ë²„ì „ìœ¼ë¡œ ë˜ëŒë¦¬ê¸°

on:
  workflow_dispatch:  # ìˆ˜ë™ìœ¼ë¡œë§Œ ì‹¤í–‰
    inputs:
      commit_sha:
        description: 'ë˜ëŒë¦´ ì»¤ë°‹ SHA (ë¹„ì›Œë‘ë©´ ì´ì „ ì»¤ë°‹)'
        required: false
        type: string

jobs:
  rollback:
    name: Rollback to Previous Version
    runs-on: ubuntu-latest
    
    steps:
      - name: Rollback ì‹œì‘
        run: |
          echo "âš ï¸ Rollback ì‹œì‘..."
          echo "ëŒ€ìƒ ì»¤ë°‹: ${{ github.event.inputs.commit_sha || 'ì´ì „ ì»¤ë°‹' }}"
      
      - name: EC2 Rollback
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            echo "ğŸ”™ Rollback ì§„í–‰ ì¤‘..."
            
            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ì°¾ê¸°
            if [ -d ~/scentence ]; then
              PROJECT_DIR=~/scentence
            elif [ -d ~/Scentence_aws ]; then
              PROJECT_DIR=~/Scentence_aws
            elif [ -d /home/ubuntu/scentence ]; then
              PROJECT_DIR=/home/ubuntu/scentence
            else
              echo "âŒ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
              echo "í˜„ì¬ í™ˆ ë””ë ‰í† ë¦¬ ë‚´ìš©:"
              ls -la ~/ || true
              exit 1
            fi
            
            echo "ğŸ“ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬: $PROJECT_DIR"
            cd $PROJECT_DIR
            
            # ì»¤ë°‹ SHAê°€ ì§€ì •ë˜ì—ˆìœ¼ë©´ í•´ë‹¹ ì»¤ë°‹ìœ¼ë¡œ, ì•„ë‹ˆë©´ ì´ì „ ì»¤ë°‹ìœ¼ë¡œ
            if [ -n "${{ github.event.inputs.commit_sha }}" ]; then
              git reset --hard ${{ github.event.inputs.commit_sha }}
            else
              git reset --hard HEAD~1
            fi
            
            # Docker ì¬ì‹œì‘
            docker compose -f docker-compose.production.yml down
            docker compose -f docker-compose.production.yml up -d --build
            
            echo "âœ… Rollback ì™„ë£Œ!"
            docker ps
      
      - name: í—¬ìŠ¤ì²´í¬
        run: |
          echo "ğŸ¥ ì„œë¹„ìŠ¤ í—¬ìŠ¤ì²´í¬..."
          sleep 30
          curl -f https://scentence.kro.kr/api/backend-openapi || exit 1
          echo "âœ… Rollback ì„±ê³µ!"
