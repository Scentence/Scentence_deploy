name: Sync to AWS Test Repository

on:
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ë§Œ (ë°°í¬ ì „ í…ŒìŠ¤íŠ¸ìš©)

jobs:
  # 1ë‹¨ê³„: CI í†µê³¼ í™•ì¸
  wait-for-ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Wait for other checks to complete
        uses: lewagon/wait-on-check-action@v1.3.1
        with:
          ref: ${{ github.sha }}
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10
          running-workflow-name: 'wait-for-ci'

  # 2ë‹¨ê³„: í…ŒìŠ¤íŠ¸ ë ˆí¬ì— PR ìƒì„±
  create-pr-to-aws-test:
    needs: wait-for-ci
    runs-on: ubuntu-latest
    env:
      # ë ˆí¬ ë³€ê²½ ì‹œ ì´ ê°’ë§Œ ìˆ˜ì •
      DEPLOY_REPO: Scentence/Scentence_aws_test
    steps:
      - name: Checkout main repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false
      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add deploy remote and create PR
        env:
          AWS_TOKEN: ${{ secrets.AWS_REPO_TOKEN }}
          GH_TOKEN: ${{ secrets.AWS_REPO_TOKEN }}
        run: |
          SOURCE_SHA=$(git rev-parse HEAD)
          git remote add deploy https://x-access-token:${AWS_TOKEN}@github.com/${DEPLOY_REPO}.git
          git fetch deploy main

          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BRANCH_NAME="sync-from-main-${TIMESTAMP}"
          git checkout -b "$BRANCH_NAME" deploy/main
          git checkout "$SOURCE_SHA" -- .
          git rm -f .github/workflows/sync-to-aws-test.yml
          git add -A
          git commit -m "chore: sync from main $(echo $SOURCE_SHA | cut -c1-7)"
          git push deploy "$BRANCH_NAME"

          gh label create "auto-sync" --repo ${{ env.DEPLOY_REPO }} --color "0E8A16" --description "Auto Sync" || true
          gh label create "deployment" --repo ${{ env.DEPLOY_REPO }} --color "0075ca" --description "Deployment" || true
          gh pr create \
            --repo ${{ env.DEPLOY_REPO }} \
            --base main \
            --head "$BRANCH_NAME" \
            --title "ğŸ§ª Test sync: $(echo $SOURCE_SHA | cut -c1-7)" \
            --body "## ğŸ§ª ë°°í¬ ì „ í…ŒìŠ¤íŠ¸ ë™ê¸°í™”

          **ì†ŒìŠ¤**: [Scentence/Scentence](https://github.com/Scentence/Scentence)
          **ëŒ€ìƒ**: [Scentence/Scentence_aws_test](https://github.com/Scentence/Scentence_aws_test) (ë°°í¬ ì „ í…ŒìŠ¤íŠ¸ìš©)
          **ì»¤ë°‹**: \`${{ github.sha }}\`
          **ì‘ì„±ì**: @${{ github.actor }}
          **ì‹œê°„**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')

          ---

          ### âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸
          - [x] ë©”ì¸ ë ˆí¬ CI í†µê³¼
          - [ ] í…ŒìŠ¤íŠ¸ í™˜ê²½ ë°°í¬ ê²€ì¦
          - [ ] í”„ë¡œë•ì…˜ ë°°í¬ ì—¬ë¶€ ê²°ì •

          ### ğŸ“ ìµœê·¼ ì»¤ë°‹
          \`\`\`
          ${{ github.event.head_commit.message }}
          \`\`\`

          **ë°°í¬ ì „ í…ŒìŠ¤íŠ¸ìš© ë ˆí¬ì…ë‹ˆë‹¤. ë¨¸ì§€ í›„ í…ŒìŠ¤íŠ¸ ì„œë²„ì— ë°˜ì˜ë©ë‹ˆë‹¤.**" \
            --label "auto-sync" \
            --label "deployment"

          echo "âœ… í…ŒìŠ¤íŠ¸ ë ˆí¬ PR ìƒì„± ì™„ë£Œ: https://github.com/${DEPLOY_REPO}/pulls"
